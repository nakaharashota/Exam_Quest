<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æº€ç‚¹ã‚¯ã‚¨ã‚¹ãƒˆ ã€œæ–°4å¹´ç”Ÿæ¼¢å­—ç·¨ã€œ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="card">
    <h1>æº€ç‚¹ã‚¯ã‚¨ã‚¹ãƒˆ</h1>
    <div class="sub-title">ã€œæ–°4å¹´ç”Ÿæ¼¢å­—ç·¨ã€œ</div>

    <div id="category-area">
        <div class="mode-selector-top">
            <p style="margin-bottom: 8px; font-weight: bold; color: #555;">é›£æ˜“åº¦ã‚’ãˆã‚‰ã¶</p>
            <div class="mode-tabs">
                <button id="tab-easy" class="tab-btn" onclick="changeMode('easy')">ã‹ã‚“ãŸã‚“</button>
                <button id="tab-normal" class="tab-btn" onclick="changeMode('normal')">ãµã¤ã†</button>
                <button id="tab-hard" class="tab-btn" onclick="changeMode('hard')">ã‚€ãšã„</button>
                <button id="tab-oni" class="tab-btn" onclick="changeMode('oni')">ãŠã«</button>
            </div>
        </div>

        <p style="text-align:center; margin: 20px 0 10px;">ä¿®è¡Œã™ã‚‹å†…å®¹ã‚’é¸ã‚“ã§ã­</p>
        <div id="category-buttons">
            <button class="btn-primary btn-d1" onclick="selectCategory('d1')">â‘  èª­ã¿ã®è©¦ç·´ï¼ˆ4æŠï¼‰</button>
            <button class="btn-primary btn-d2" onclick="selectCategory('d2')">â‘¡ æ›¸ãã®é–¢æ‰€ï¼ˆãƒãƒ¼ãƒˆï¼‰</button>
            <button class="btn-primary btn-d3" onclick="selectCategory('d3')">â‘¢ ä½¿ã„åˆ†ã‘ã®è¿·å®®ï¼ˆ4æŠï¼‰</button>
            <button class="btn-primary btn-d4" onclick="selectCategory('d4')">â‘£ ç†Ÿèªã®è©¦ç·´ï¼ˆ4æŠï¼‰</button>
            <button class="btn-primary btn-d5" onclick="selectCategory('d5')">â‘¤ ç©¶æ¥µã®ä½¿ã„åˆ†ã‘ï¼ˆ4æŠï¼‰</button>
        </div>

        <div class="reset-link"><a href="#" onclick="resetData()">é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ</a></div>
    </div>

    <div id="level-area" style="display:none;">
        <button style="background:#eee;" onclick="showCategory()">â† ã‚‚ã©ã‚‹</button>
        <p id="level-title" style="text-align:center; font-weight:bold; margin-top:15px;"></p>
        <div id="level-buttons"></div>
    </div>

    <div id="quiz-area" style="display:none;">
        <div class="timer-container"><div id="timer-bar"></div></div>
        <div id="progress" style="text-align:right; color:#888;"></div>
        <div id="guide" class="guide-msg"></div>
        <div id="question" class="question-box"></div>
        <div id="choices-area"></div>
        <div id="feedback" class="feedback" style="display:none;"><div id="result-text"></div></div>
        <button id="next-btn" class="btn-primary" style="display:none;">æ¬¡ã¸é€²ã‚€</button>
    </div>

    <div id="selfcheck-area" style="display:none;">
        <h2 style="text-align:center;">ç­”ãˆåˆã‚ã›</h2>
        <div id="answer-list" style="margin-bottom:20px;"></div>
        <div style="text-align:center; border-top: 2px solid #eee; padding-top:20px;">
            <p>ä½•å•æ­£è§£ã ã£ãŸï¼Ÿ</p>
            <input type="number" id="self-count" min="0" max="5" value="0"> å• / 5å•
            <button class="btn-primary" onclick="submitSelfScore()">ç‚¹æ•°ã‚’ç¢ºèªã™ã‚‹</button>
        </div>
    </div>

    <div id="score-area" style="display:none;">
        <h2 style="text-align:center;">çµæœç™ºè¡¨</h2>
        <div id="final-score" style="font-size:3rem; text-align:center; color:#1a73e8; margin:20px 0;"></div>
        <div id="clear-msg" style="text-align:center; margin-bottom:20px; font-weight:bold; color:#1e8e3e;"></div>
        <button class="btn-primary" id="retry-btn">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
        <button class="btn-primary" id="next-lv-btn" style="background-color:#34a853;">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸</button>
        <button style="background:#e8f0fe; color:#1a73e8;" onclick="showLevel()">ãƒ¬ãƒ™ãƒ«é¸æŠã«æˆ»ã‚‹</button>
        <button style="background:#eee;" onclick="showCategory()">ã‚«ãƒ†ã‚´ãƒªé¸æŠã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
    const JSON_BASE_PATH = 'assets/json/shin4_kanji';
    const TOTAL_QUESTIONS = 5;
    
    let currentCategory = '';
    let currentMode = localStorage.getItem('shin4_selected_mode') || 'easy';
    let currentLevel = 1;
    let quizData = [];
    let currentIdx = 0;
    let correctCount = 0;
    let timeLimit = 0;
    let timeRemaining = 0;
    let timerInterval = null;

    window.onload = () => {
        updateCategoryList();
    };

    function hideAll() {
        ['category-area','level-area','quiz-area','selfcheck-area','score-area'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        });
    }

    function showCategory() {
        hideAll();
        document.getElementById('category-area').style.display = 'block';
        updateCategoryList();
    }

    // ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã®å‡¦ç†
    function changeMode(mode) {
        currentMode = mode;
        localStorage.setItem('shin4_selected_mode', mode);
        updateCategoryList();
    }

    // ã‚«ãƒ†ã‚´ãƒªç”»é¢ã®æ›´æ–°ï¼ˆã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã¨Lvè¡¨ç¤ºï¼‰
    function updateCategoryList() {
        // ã‚¿ãƒ–ã®è¦‹ãŸç›®ã‚’æ›´æ–°
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${currentMode}`).classList.add('active');

        // å„ã‚«ãƒ†ã‚´ãƒªã®Lvè¡¨ç¤ºã‚’æ›´æ–°
        const cats = ['d1', 'd2', 'd3', 'd4', 'd5'];
        cats.forEach(cat => {
            const storageKey = `shin4_${cat}_${currentMode}_progress`;
            const unlocked = parseInt(localStorage.getItem(storageKey)) || 1;
            const btn = document.querySelector(`.btn-${cat}`);
            if (btn) {
                const baseNames = {
                    'd1': 'â‘  èª­ã¿ã®è©¦ç·´ï¼ˆ4æŠï¼‰',
                    'd2': 'â‘¡ æ›¸ãã®é–¢æ‰€ï¼ˆãƒãƒ¼ãƒˆï¼‰',
                    'd3': 'â‘¢ ä½¿ã„åˆ†ã‘ã®è¿·å®®ï¼ˆ4æŠï¼‰',
                    'd4': 'â‘£ ç†Ÿèªã®è©¦ç·´ï¼ˆ4æŠï¼‰',
                    'd5': 'â‘¤ ç©¶æ¥µã®ä½¿ã„åˆ†ã‘ï¼ˆ4æŠï¼‰'
                };
                const displayLv = unlocked > 5 ? 5 : unlocked;
                btn.innerText = `${baseNames[cat]} [Lv.${displayLv}]`;
            }
        });
    }

    function selectCategory(cat) {
        currentCategory = cat;
        showLevel();
    }

    function showLevel() {
        hideAll();
        document.getElementById('level-area').style.display = 'block';
        const titles = { 'd1': 'ã€èª­ã¿ã€‘', 'd2': 'ã€æ›¸ãã€‘', 'd3': 'ã€ä½¿ã„åˆ†ã‘ã€‘', 'd4': 'ã€ç†Ÿèªã€‘', 'd5': 'ã€ç©¶æ¥µã€‘' };
        const modeNames = { 'easy':'ã‹ã‚“ãŸã‚“', 'normal':'ãµã¤ã†', 'hard':'ã‚€ãšã‹ã—ã„', 'oni':'ãŠã«' };
        document.getElementById('level-title').innerText = `${titles[currentCategory]} (${modeNames[currentMode]})`;
        renderLevels();
    }

    function renderLevels() {
        const btnContainer = document.getElementById('level-buttons');
        btnContainer.innerHTML = '';
        const storageKey = `shin4_${currentCategory}_${currentMode}_progress`;
        const unlockedLevel = parseInt(localStorage.getItem(storageKey)) || 1;
        for(let lv=1; lv<=5; lv++) {
            const btn = document.createElement('button');
            if (lv <= unlockedLevel) {
                btn.className = 'btn-primary';
                btn.innerText = `ãƒ¬ãƒ™ãƒ« ${lv}`;
                btn.onclick = () => loadStage(lv);
            } else {
                btn.className = 'btn-locked';
                btn.innerText = `ãƒ¬ãƒ™ãƒ« ${lv}`;
                btn.onclick = () => alert("å‰ã®ãƒ¬ãƒ™ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã­ï¼");
            }
            btnContainer.appendChild(btn);
        }
    }

    async function loadStage(level) {
        currentLevel = level;
        const filePath = `${JSON_BASE_PATH}/stage_${currentCategory}.json`;
        try {
            const response = await fetch(filePath);
            const data = await response.json();
            const levelData = data.levels.find(l => l.level == level);
            quizData = levelData.questions.sort(() => 0.5 - Math.random()).slice(0, TOTAL_QUESTIONS);
            
            currentIdx = 0; correctCount = 0;
            hideAll();
            document.getElementById('quiz-area').style.display = 'block';
            
            clearInterval(timerInterval);
            const limits = { 'easy': 0, 'normal': 75, 'hard': 50, 'oni': 25 };
            timeLimit = limits[currentMode];
            
            if (timeLimit > 0) {
                timeRemaining = timeLimit;
                document.querySelector('.timer-container').style.display = 'block';
                startTimer();
            } else {
                document.querySelector('.timer-container').style.display = 'none';
            }
            loadQuestion();
        } catch (e) { alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
    }

    function startTimer() {
        const bar = document.getElementById('timer-bar');
        bar.style.width = "100%";
        bar.style.backgroundColor = "#34a853";
        timerInterval = setInterval(() => {
            timeRemaining -= 0.1;
            let percent = (timeRemaining / timeLimit) * 100;
            if (percent < 0) percent = 0;
            bar.style.width = percent + "%";
            if (percent < 25) bar.style.backgroundColor = "#d93025";
            else if (percent < 50) bar.style.backgroundColor = "#f4b400";
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                alert("ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼");
                finishQuiz();
            }
        }, 100);
    }

    function loadQuestion() {
        const current = quizData[currentIdx];
        document.getElementById('progress').innerText = `${currentIdx + 1} / ${TOTAL_QUESTIONS}`;
        document.getElementById('feedback').style.display = 'none';
        const choicesArea = document.getElementById('choices-area');
        const nextBtn = document.getElementById('next-btn');
        choicesArea.innerHTML = '';

        if (currentCategory !== 'd2') {
            document.getElementById('guide').innerText = "æ­£ã—ã„ã‚‚ã®ã‚’é¸ã‚“ã§ã­ï¼";
            document.getElementById('question').innerText = current.q;
            nextBtn.style.display = 'none';
            [...current.choices].sort(() => 0.5 - Math.random()).forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = choice;
                btn.onclick = () => {
                    Array.from(document.getElementsByClassName('choice-btn')).forEach(b => b.disabled = true);
                    const feedback = document.getElementById('feedback');
                    if (choice === current.a) {
                        document.getElementById('result-text').innerText = "â­• æ­£è§£ï¼";
                        feedback.className = "feedback correct";
                        correctCount++;
                    } else {
                        document.getElementById('result-text').innerText = `âŒ æ®‹å¿µï¼ æ­£è§£ã¯ã€Œ${current.a}ã€`;
                        feedback.className = "feedback wrong";
                    }
                    feedback.style.display = 'block';
                    nextBtn.style.display = 'block';
                };
                choicesArea.appendChild(btn);
            });
        } else {
            document.getElementById('guide').innerText = "ãƒãƒ¼ãƒˆã«æ¼¢å­—ã‚’æ›¸ã„ã¦ã­ï¼";
            document.getElementById('question').innerText = current.q.replace('ï¼ˆã€€ï¼‰', `ï¼ˆ ${current.k || ''} ï¼‰`);
            nextBtn.style.display = 'block';
        }
    }

    document.getElementById('next-btn').onclick = () => {
        currentIdx++;
        if (currentIdx < quizData.length) loadQuestion();
        else finishQuiz();
    };

    function finishQuiz() {
        clearInterval(timerInterval);
        hideAll();
        if (currentCategory === 'd2') showSelfCheck();
        else showScore(correctCount * 20);
    }

    function showSelfCheck() {
        const listEl = document.getElementById('answer-list');
        listEl.innerHTML = '';
        quizData.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'answer-item';
            div.innerHTML = `<strong>${idx+1}.</strong> ${item.q.replace('ï¼ˆã€€ï¼‰', `ï¼ˆ${item.k}ï¼‰`)} â†’ <span style="color:#d93025; font-weight:bold;">${item.a}</span>`;
            listEl.appendChild(div);
        });
        document.getElementById('selfcheck-area').style.display = 'block';
    }

    function submitSelfScore() { showScore(document.getElementById('self-count').value * 20); }

    function showScore(finalScore) {
        hideAll();
        document.getElementById('score-area').style.display = 'block';
        document.getElementById('final-score').innerText = `${finalScore} ç‚¹`;
        const clearMsg = document.getElementById('clear-msg');
        const nextLvBtn = document.getElementById('next-lv-btn');
        if (finalScore >= 80) {
            clearMsg.innerText = "ğŸŒŸ åˆæ ¼ï¼æ¬¡ã®ãƒ¬ãƒ™ãƒ«ãŒé–‹æ”¾ã•ã‚ŒãŸã‚ˆï¼";
            const storageKey = `shin4_${currentCategory}_${currentMode}_progress`;
            const currentUnlocked = parseInt(localStorage.getItem(storageKey)) || 1;
            if (currentLevel >= currentUnlocked) localStorage.setItem(storageKey, currentLevel + 1);
            nextLvBtn.style.display = currentLevel < 5 ? 'block' : 'none';
        } else {
            clearMsg.innerText = "ã‚ã¨å°‘ã—ï¼ã‚‚ã†ä¸€åº¦ã‚„ã£ã¦ã¿ã‚ˆã†ã€‚";
            nextLvBtn.style.display = 'none';
        }
        document.getElementById('retry-btn').onclick = () => loadStage(currentLevel);
        nextLvBtn.onclick = () => loadStage(currentLevel + 1);
    }

    function resetData() { if(confirm('é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>