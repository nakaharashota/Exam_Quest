<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam_Quest | 漢字攻略</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; border-radius: 15px; width: 100%; max-width: 500px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h1 { color: #1a73e8; text-align: center; font-size: 1.5rem; margin-bottom: 20px; }
        .question-box { font-size: 1.8rem; text-align: center; margin: 30px 0; font-weight: bold; color: #333; line-height: 1.6; }
        .guide-msg { text-align: center; color: #666; margin-bottom: 10px; font-weight: bold; }
        button { width: 100%; padding: 12px; font-size: 1.1rem; border: none; border-radius: 8px; cursor: pointer; transition: background 0.2s; margin-top: 10px; }
        .btn-primary { background-color: #1a73e8; color: white; }
        .btn-primary:hover { background-color: #1557b0; }
        .choice-btn { background-color: #ffffff; border: 2px solid #1a73e8; color: #1a73e8; margin-bottom: 10px; text-align: left; padding-left: 20px; }
        .choice-btn:hover { background-color: #e8f0fe; }
        .choice-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .feedback { padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; font-weight: bold; }
        .correct { background-color: #e6f4ea; color: #1e8e3e; }
        .wrong { background-color: #fce8e6; color: #d93025; }
        #selfcheck-area, #score-area, #level-area, #quiz-area { display: none; }
        .answer-item { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 1rem; }
        input[type="number"] { width: 60px; padding: 8px; font-size: 1.2rem; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

<div class="card">
    <h1>Exam_Quest</h1>

    <div id="category-area">
        <p style="text-align:center;">モードを選んでね</p>
        <button class="btn-primary" onclick="selectCategory('d1')">① 読みの試練（4択）</button>
        <button class="btn-primary" onclick="selectCategory('d2')">② 書きの関所（ノート）</button>
    </div>

    <div id="level-area">
        <button onclick="location.reload()">← もどる</button>
        <div id="level-buttons"></div>
    </div>

    <div id="quiz-area">
        <div id="progress" style="text-align:right; color:#888;"></div>
        <div id="guide" class="guide-msg"></div>
        <div id="question" class="question-box"></div>
        
        <div id="choices-area"></div>

        <div id="feedback" class="feedback">
            <div id="result-text"></div>
        </div>

        <button id="next-btn" class="btn-primary" style="display:none;">次へ進む</button>
    </div>

    <div id="selfcheck-area">
        <h2>答え合わせ</h2>
        <p>ノートの漢字と見比べてね！</p>
        <div id="answer-list" style="margin-bottom:20px; text-align:left;"></div>
        <div style="text-align:center; border-top: 2px solid #eee; padding-top:20px;">
            <p>何問正解だった？</p>
            <input type="number" id="self-count" min="0" max="5" value="0"> 問 / 5問
            <button class="btn-primary" onclick="submitSelfScore()">点数を出す</button>
        </div>
    </div>

    <div id="score-area">
        <h2 style="text-align:center;">結果発表</h2>
        <div id="final-score" style="font-size:3rem; text-align:center; color:#1a73e8; margin:20px 0;"></div>
        <button class="btn-primary" onclick="location.reload()">もう一度あそぶ</button>
    </div>
</div>

<script>
    let quizData = [];
    let currentIdx = 0;
    let autoScore = 0;
    let isChoiceMode = false;
    const TOTAL_QUESTIONS = 5;

    function selectCategory(cat) {
        document.getElementById('category-area').style.display = 'none';
        const levelArea = document.getElementById('level-area');
        levelArea.style.display = 'block';
        
        const btnContainer = document.getElementById('level-buttons');
        btnContainer.innerHTML = '';
        [1,2,3,4,5].forEach(lv => {
            const btn = document.createElement('button');
            btn.className = 'btn-primary';
            btn.innerText = `レベル ${lv}`;
            btn.onclick = () => loadStage(cat, lv);
            btnContainer.appendChild(btn);
        });
    }

    async function loadStage(cat, level) {
        try {
            const response = await fetch(`assets/json/stage_${cat}.json`);
            const data = await response.json();
            
            let allQuestions = [];
            if (data.levels) {
                const levelData = data.levels.find(l => l.level == level);
                allQuestions = levelData ? levelData.questions : [];
            } else {
                allQuestions = data;
            }

            // シャッフルして5問選ぶ
            quizData = allQuestions.sort(() => 0.5 - Math.random()).slice(0, TOTAL_QUESTIONS);
            
            if (quizData.length === 0) {
                alert("問題がありません");
                return;
            }

            currentIdx = 0;
            autoScore = 0;
            document.getElementById('level-area').style.display = 'none';
            document.getElementById('quiz-area').style.display = 'block';
            loadQuestion();
        } catch (e) {
            alert("読み込みエラー");
        }
    }

    function loadQuestion() {
        const current = quizData[currentIdx];
        document.getElementById('progress').innerText = `${currentIdx + 1} / ${TOTAL_QUESTIONS}`;
        document.getElementById('feedback').style.display = 'none';
        
        const choicesArea = document.getElementById('choices-area');
        const nextBtn = document.getElementById('next-btn');
        const guide = document.getElementById('guide');
        const questionEl = document.getElementById('question');
        
        choicesArea.innerHTML = '';
        
        // 選択肢（choices）があるかどうかでモードを判定
        if (current.choices && current.choices.length > 0) {
            isChoiceMode = true;
            guide.innerText = "正しい読みを選んでね！";
            questionEl.innerText = current.q;
            nextBtn.style.display = 'none'; // 選択するまで隠す

            const shuffledChoices = [...current.choices].sort(() => 0.5 - Math.random());
            shuffledChoices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = choice;
                btn.onclick = () => {
                    Array.from(document.getElementsByClassName('choice-btn')).forEach(b => b.disabled = true);
                    const feedback = document.getElementById('feedback');
                    const resText = document.getElementById('result-text');
                    if (choice === current.a) {
                        resText.innerText = "⭕ 正解！";
                        feedback.className = "feedback correct";
                        autoScore += 20;
                    } else {
                        resText.innerText = `❌ 残念！ 正解は「${current.a}」`;
                        feedback.className = "feedback wrong";
                    }
                    feedback.style.display = 'block';
                    nextBtn.style.display = 'block';
                };
                choicesArea.appendChild(btn);
            });
        } else {
            isChoiceMode = false;
            guide.innerText = "ノートに漢字を書いてね！";
            // 書き問題は読み仮名を表示
            questionEl.innerText = current.q.replace('（　）', `（ ${current.k || ''} ）`);
            nextBtn.style.display = 'block'; // ノート用なので最初から「次へ」を出す
        }
    }

    document.getElementById('next-btn').onclick = () => {
        currentIdx++;
        if (currentIdx < quizData.length) {
            loadQuestion();
        } else {
            document.getElementById('quiz-area').style.display = 'none';
            if (isChoiceMode) {
                showScore(autoScore);
            } else {
                showSelfCheck();
            }
        }
    };

    function showSelfCheck() {
        const listEl = document.getElementById('answer-list');
        listEl.innerHTML = '';
        quizData.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'answer-item';
            const qShow = item.q.replace('（　）', `（${item.k}）`);
            div.innerHTML = `<strong>${idx + 1}.</strong> ${qShow} <br> <span style="color:#d93025; font-weight:bold;">正解：${item.a}</span>`;
            listEl.appendChild(div);
        });
        document.getElementById('selfcheck-area').style.display = 'block';
    }

    function submitSelfScore() {
        const count = document.getElementById('self-count').value;
        showScore(count * 20);
    }

    function showScore(finalScore) {
        document.getElementById('selfcheck-area').style.display = 'none';
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('score-area').style.display = 'block';
        document.getElementById('final-score').innerText = `${finalScore} 点`;
    }
</script>

</body>
</html>