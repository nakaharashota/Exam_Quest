<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam_Quest | 漢字攻略</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; border-radius: 15px; shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 500px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h1 { color: #1a73e8; text-align: center; font-size: 1.5rem; margin-bottom: 20px; }
        .question-box { font-size: 2rem; text-align: center; margin: 30px 0; font-weight: bold; color: #333; }
        input[type="text"] { width: 100%; padding: 12px; font-size: 1.2rem; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; }
        button { width: 100%; padding: 12px; font-size: 1.1rem; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .btn-category { margin-bottom: 8px; background-color: #ffca28; color: #333; font-size: 1.2rem; }
        .btn-level { margin-bottom: 6px; background-color: #29b6f6; color: white; }
        .choice-btn { margin: 4px 0; background-color: #fbbc05; color: #333; }
        .btn-check { background-color: #1a73e8; color: white; }
        .btn-next { background-color: #34a853; color: white; display: none; }
        .feedback { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; }
        .correct { background-color: #e6f4ea; color: #1e8e3e; border: 1px solid #1e8e3e; }
        .wrong { background-color: #fce8e6; color: #d93025; border: 1px solid #d93025; }
        .note { font-size: 0.9rem; margin-top: 10px; color: #555; line-height: 1.5; }
        .score-screen { text-align: center; display: none; }
    </style>
</head>
<body>

<div class="card" id="game-container">
    <h1>⚔️ Exam_Quest 漢字編</h1>
    
    <!--カテゴリ選択画面-->
    <div id="category-area">
        <p>挑戦したいカテゴリを選択してください</p>
        <button class="btn-category" data-cat="1">① 読みの試練</button>
        <button class="btn-category" data-cat="2">② 書きの試練</button>
        <button class="btn-category" data-cat="3">③ 四字熟語の塔</button>
        <button class="btn-category" data-cat="4">④ 漢字クイズ道場</button>
        <button class="btn-category" data-cat="5">⑤ 間違い探しの城</button>
    </div>

    <!--レベル選択画面-->
    <div id="level-area" style="display:none;">
        <p id="level-title">レベルを選んでください</p>
        <button class="btn-level" data-level="1">Lv.1</button>
        <button class="btn-level" data-level="2">Lv.2</button>
        <button class="btn-level" data-level="3">Lv.3</button>
        <button class="btn-level" data-level="4">Lv.4</button>
        <button class="btn-level" data-level="5">Lv.5</button>
        <button id="back-to-cat" style="margin-top:10px;">◀ カテゴリへ戻る</button>
    </div>

    <!--クイズ部分-->
    <div id="quiz-area" style="display:none;">
        <div id="progress">第 1 問 / 5問</div>
        <div class="question-box" id="question">太陽</div>
        <div id="choices-area" style="display:none;">
            <!-- 選択肢ボタンはここに動的生成 -->
        </div>
        <div id="input-area">
            <input type="text" id="answer-input" placeholder="よみがなを入力..." autocomplete="off">
            <button class="btn-check" id="check-btn">判定する</button>
        </div>
        <div class="feedback" id="feedback">
            <div id="result-text" style="font-weight: bold;"></div>
            <div class="note" id="explanation"></div>
            <button class="btn-next" id="next-btn" style="margin-top: 15px;">次の問題へ ➔</button>
        </div>
    </div>

    <div class="score-screen" id="score-area" style="display:none;">
        <h2>結果発表</h2>
        <div style="font-size: 3rem; margin: 20px 0;" id="final-score">0点</div>
        <button class="btn-check" onclick="location.reload()">もう一度挑戦する</button>
    </div>
</div>

<script>
    let quizData = [];
    let currentIdx = 0;
    let score = 0;
    let selectedCategory = null;
    let selectedLevel = null;

    const qEl = document.getElementById('question');
    const inputEl = document.getElementById('answer-input');
    const checkBtn = document.getElementById('check-btn');
    const nextBtn = document.getElementById('next-btn');
    const feedbackEl = document.getElementById('feedback');
    const resultText = document.getElementById('result-text');
    const explEl = document.getElementById('explanation');
    const progressEl = document.getElementById('progress');

    const choicesArea = document.getElementById('choices-area');
    const inputArea = document.getElementById('input-area');
    const categoryArea = document.getElementById('category-area');
    const levelArea = document.getElementById('level-area');
    const quizArea = document.getElementById('quiz-area');
    const levelTitle = document.getElementById('level-title');
    const backToCatBtn = document.getElementById('back-to-cat');

    // カテゴリボタンにイベント
    document.querySelectorAll('.btn-category').forEach(btn => {
        btn.addEventListener('click', () => {
            selectedCategory = btn.dataset.cat;
            showLevels(selectedCategory);
        });
    });

    // レベルボタン
    document.querySelectorAll('.btn-level').forEach(btn => {
        btn.addEventListener('click', () => {
            selectedLevel = btn.dataset.level;
            loadStage(selectedCategory, selectedLevel);
        });
    });

    backToCatBtn.addEventListener('click', () => {
        levelArea.style.display = 'none';
        categoryArea.style.display = 'block';
    });

    function showLevels(cat) {
        levelTitle.innerText = `カテゴリ ${cat} のレベルを選択`;
        categoryArea.style.display = 'none';
        levelArea.style.display = 'block';
    }

    function loadStage(cat, level) {
        const path = `assets/json/stage_d${cat}.json`;
        fetch(path)
            .then(resp => {
                if (!resp.ok) throw new Error('読み込み失敗');
                return resp.json();
            })
            .then(data => {
                // 新しい形式: { levels: [ {level, questions}, ... ] }
                if (data.levels && Array.isArray(data.levels)) {
                    const lvl = data.levels.find(l => String(l.level) === String(level));
                    if (lvl) {
                        quizData = lvl.questions || [];
                    } else {
                        quizData = [];
                        console.warn('指定レベルが見つかりません', level);
                    }
                } else if (Array.isArray(data)) {
                    // 旧形式をサポート (配列直下)
                    quizData = data;
                } else {
                    quizData = [];
                }
                startQuiz();
            })
            .catch(err => {
                alert('問題データの読み込みに失敗しました');
                console.error(err);
            });
    }

    function startQuiz() {
        levelArea.style.display = 'none';
        quizArea.style.display = 'block';
        currentIdx = 0;
        score = 0;
        loadQuestion();
    }

    function loadQuestion() {
        const current = quizData[currentIdx];
        qEl.innerText = current.q;
        feedbackEl.style.display = 'none';
        nextBtn.style.display = 'none';
        progressEl.innerText = `第 ${currentIdx + 1} 問 / ${quizData.length}問`;

        // 選択肢の有無で入力フィールド/ボタンを切り替え
        if (current.choices && current.choices.length > 0) {
            // 4択
            inputArea.style.display = 'none';
            choicesArea.style.display = 'block';
            populateChoices(current.choices);
        } else {
            // 自由入力
            choicesArea.style.display = 'none';
            inputArea.style.display = 'block';
            inputEl.value = '';
        }
    }

    function populateChoices(choices) {
        choicesArea.innerHTML = '';
        choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = ' choice-btn';
            btn.textContent = choice;
            btn.dataset.value = choice;
            btn.addEventListener('click', () => {
                evaluateAnswer(choice);
            });
            choicesArea.appendChild(btn);
        });
    }

    function evaluateAnswer(ans) {
        const current = quizData[currentIdx];
        feedbackEl.style.display = 'block';
        nextBtn.style.display = 'block';
        if (inputArea.style.display !== 'none') {
            checkBtn.style.display = 'none';
        } else {
            // 選択肢の場合はボタン無効化
            Array.from(choicesArea.children).forEach(b => b.disabled = true);
        }

        if (ans === current.a) {
            resultText.innerText = '⭕ 正解！';
            feedbackEl.className = 'feedback correct';
            score += 20;
        } else {
            resultText.innerText = `❌ おしい！ 正解は「${current.a}」`;
            feedbackEl.className = 'feedback wrong';
        }
        explEl.innerText = current.note || '';
    }

    // 判定ボタン押下 (入力式)
    checkBtn.onclick = () => {
        evaluateAnswer(inputEl.value.trim());
    };

    // 次へボタン
    nextBtn.onclick = () => {
        currentIdx++;
        if (currentIdx < quizData.length) {
            loadQuestion();
        } else {
            showScore();
        }
    };

    function showScore() {
        quizArea.style.display = 'none';
        document.getElementById('score-area').style.display = 'block';
        document.getElementById('final-score').innerText = score + '点';
    }
</script>
</body>
</html>