<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam_Quest | 漢字攻略</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; border-radius: 15px; shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 500px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h1 { color: #1a73e8; text-align: center; font-size: 1.5rem; margin-bottom: 20px; }
        .question-box { font-size: 2rem; text-align: center; margin: 30px 0; font-weight: bold; color: #333; }
        input[type="text"] { width: 100%; padding: 12px; font-size: 1.2rem; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; }
        button { width: 100%; padding: 12px; font-size: 1.1rem; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .btn-category { margin-bottom: 8px; background-color: #ffca28; color: #333; font-size: 1.2rem; }
        .btn-level { margin-bottom: 6px; background-color: #29b6f6; color: white; }
        .choice-btn { margin: 4px 0; background-color: #fbbc05; color: #333; }
        .btn-check { background-color: #1a73e8; color: white; }
        .btn-next { background-color: #34a853; color: white; display: none; }
        .feedback { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; }
        .correct { background-color: #e6f4ea; color: #1e8e3e; border: 1px solid #1e8e3e; }
        .wrong { background-color: #fce8e6; color: #d93025; border: 1px solid #d93025; }
        .note { font-size: 0.9rem; margin-top: 10px; color: #555; line-height: 1.5; }
        .score-screen { text-align: center; display: none; }
    </style>
</head>
<body>

<div class="card" id="game-container">
    <h1>⚔️ Exam_Quest 漢字編</h1>
    
    <!--カテゴリ選択画面-->
    <div id="category-area">
        <p>挑戦したいカテゴリを選択してください</p>
        <button class="btn-category" data-cat="1">① 読みの試練</button>
        <button class="btn-category" data-cat="2">② 書きの試練</button>
        <button class="btn-category" data-cat="3">③ 四字熟語の塔</button>
        <button class="btn-category" data-cat="4">④ 漢字クイズ道場</button>
        <button class="btn-category" data-cat="5">⑤ 間違い探しの城</button>
    </div>

    <!--レベル選択画面-->
    <div id="level-area" style="display:none;">
        <p id="level-title">レベルを選んでください</p>
        <button class="btn-level" data-level="1">Lv.1</button>
        <button class="btn-level" data-level="2">Lv.2</button>
        <button class="btn-level" data-level="3">Lv.3</button>
        <button class="btn-level" data-level="4">Lv.4</button>
        <button class="btn-level" data-level="5">Lv.5</button>
        <button id="back-to-cat" style="margin-top:10px;">◀ カテゴリへ戻る</button>
    </div>

    <!--クイズ部分-->
    <div id="quiz-area" style="display:none;">
        <div id="progress">第 1 問 / 5問</div>
        <div class="question-box" id="question">太陽</div>
        <div id="choices-area" style="display:none;">
            <!-- 選択肢ボタンはここに動的生成 -->
        </div>
        <!-- 書き問題用のラベル -->
        <div id="input-label" style="text-align:center; font-size:1.1rem; margin-bottom:5px;"></div>
        <div id="input-area">
            <input type="text" id="answer-input" placeholder="漢字を入力..." autocomplete="off">
            <button class="btn-check" id="check-btn">判定する</button>
        </div>
        <div class="feedback" id="feedback">
            <div id="result-text" style="font-weight: bold;"></div>
            <div class="note" id="explanation"></div>
            <button class="btn-next" id="next-btn" style="margin-top: 15px;">次の問題へ ➔</button>
        </div>
    </div>

    <div class="score-screen" id="score-area" style="display:none;">
        <h2>結果発表</h2>
        <div style="font-size: 3rem; margin: 20px 0;" id="final-score">0点</div>
        <button class="btn-check" id="retry-btn">もう一度挑戦する</button>
        <button class="btn-check" id="restart-btn" style="margin-top:8px;">最初に戻る</button>
    </div>

    <!-- 自己採点用画面 -->
    <div class="score-screen" id="selfcheck-area" style="display:none;">
        <h2>答え合わせ</h2>
        <div id="answer-list" style="text-align:left; margin:10px 0;"></div>
        <label>何問正解した？ <input type="number" id="self-count" min="0" max="5" value="0" style="width:4rem;"></label>
        <button class="btn-check" id="calc-score-btn" style="margin-top:10px;">点数を出す</button>
    </div>
</div>

<script>
    let quizData = [];
    let currentIdx = 0;
    let score = 0;
    let selectedCategory = null;
    let selectedLevel = null;

    // utility: in-place shuffle
    function shuffleArray(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    const qEl = document.getElementById('question');
    const inputEl = document.getElementById('answer-input');
    const checkBtn = document.getElementById('check-btn');
    const nextBtn = document.getElementById('next-btn');
    const feedbackEl = document.getElementById('feedback');
    const resultText = document.getElementById('result-text');
    const explEl = document.getElementById('explanation');
    const progressEl = document.getElementById('progress');

    const choicesArea = document.getElementById('choices-area');
    const inputArea = document.getElementById('input-area');
    const categoryArea = document.getElementById('category-area');
    const levelArea = document.getElementById('level-area');
    const quizArea = document.getElementById('quiz-area');
    const levelTitle = document.getElementById('level-title');
    const backToCatBtn = document.getElementById('back-to-cat');

    // カテゴリボタンにイベント
    document.querySelectorAll('.btn-category').forEach(btn => {
        btn.addEventListener('click', () => {
            selectedCategory = btn.dataset.cat;
            showLevels(selectedCategory);
        });
    });

    // レベルボタン
    document.querySelectorAll('.btn-level').forEach(btn => {
        btn.addEventListener('click', () => {
            selectedLevel = btn.dataset.level;
            loadStage(selectedCategory, selectedLevel);
        });
    });

    backToCatBtn.addEventListener('click', () => {
        levelArea.style.display = 'none';
        categoryArea.style.display = 'block';
    });

    function showLevels(cat) {
        levelTitle.innerText = `カテゴリ ${cat} のレベルを選択`;
        categoryArea.style.display = 'none';
        levelArea.style.display = 'block';
    }

    function loadStage(cat, level) {
        const path = `assets/json/stage_d${cat}.json`;
        fetch(path)
            .then(resp => {
                if (!resp.ok) throw new Error('読み込み失敗');
                return resp.json();
            })
            .then(data => {
                // 新フォーマットでは data.levels の中に各レベルの問題群が入る
                if (data && data.levels && Array.isArray(data.levels)) {
                    const levelData = data.levels.find(l => l.level == level);
                    // 存在しないレベルの場合は空配列
                    quizData = levelData && Array.isArray(levelData.questions) ? levelData.questions : [];
                } else if (Array.isArray(data)) {
                    // 旧フォーマット（直接配列）にも対応
                    quizData = data;
                } else {
                    quizData = [];
                }
                // 問題順をランダム化（後で5問抽出予定）
                if (Array.isArray(quizData) && quizData.length > 1) {
                    shuffleArray(quizData);
                }
                startQuiz();
            })
            .catch(err => {
                alert('問題データの読み込みに失敗しました');
                console.error(err);
            });
    }

    function startQuiz() {
        levelArea.style.display = 'none';
        quizArea.style.display = 'block';
        currentIdx = 0;
        score = 0;
        if (Array.isArray(quizData) && quizData.length > 0) {
            // セッションは5問まで
            if (quizData.length > 5) {
                quizData = quizData.slice(0, 5);
            }
            loadQuestion();
        } else {
            console.warn('quizData は空です。問題が読み込まれていないか、level が間違っています');
        }
    }

    function loadQuestion() {
        const current = quizData[currentIdx];
        // 書き問題の場合は k を使ってヒント表示
        if ((!current.choices || current.choices.length === 0) && current.k) {
            qEl.innerText = current.q.replace('（　）', `（${current.k}）`);
        } else {
            qEl.innerText = current.q;
        }
        feedbackEl.style.display = 'none';
        progressEl.innerText = `第 ${currentIdx + 1} 問 / ${quizData.length}問`;

        // ラベル初期化
        document.getElementById('input-label').innerText = '';
        // 回答エリア初期化
        inputArea.style.display = 'none';
        choicesArea.style.display = 'none';
        checkBtn.style.display = 'none';
        nextBtn.style.display = 'none';

        if (current.choices && current.choices.length > 0) {
            // 読み問題 (4択)
            choicesArea.style.display = 'block';
            // 配列をシャッフルしてから表示（常に1番が正解になるバグ対策）
            const shuffled = [...current.choices];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            populateChoices(shuffled);
        } else {
            // 書き問題 (ノート学習モード)
            document.getElementById('input-label').innerText = 'ノートに書いたら「次へ」を押してね';
            // 画面には next ボタンだけ表示
            nextBtn.style.display = 'block';
        }
    }

    function populateChoices(choices) {
        choicesArea.innerHTML = '';
        choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = ' choice-btn';
            btn.textContent = choice;
            btn.dataset.value = choice;
            btn.addEventListener('click', () => {
                evaluateAnswer(choice);
            });
            choicesArea.appendChild(btn);
        });
    }

    function evaluateAnswer(ans) {
        const current = quizData[currentIdx];
        feedbackEl.style.display = 'block';
        nextBtn.style.display = 'block';
        // 判定ボタンは隠す（次へへ誘導）
        checkBtn.style.display = 'none';

        // 選択肢があればボタンを無効化して比較
        if (current.choices && current.choices.length > 0) {
            Array.from(choicesArea.children).forEach(b => b.disabled = true);
        }

        const correct = ans === current.a;
        if (correct) {
            resultText.innerText = '⭕ 正解！';
            feedbackEl.className = 'feedback correct';
            score += 20;
        } else {
            resultText.innerText = `❌ おしい！ 正解は「${current.a}」`;
            feedbackEl.className = 'feedback wrong';
        }
        explEl.innerText = current.note || '';
    }

    // 判定ボタン押下 (入力式)
    checkBtn.onclick = () => {
        evaluateAnswer(inputEl.value.trim());
    };

    // Enter キーで判定（記述式）
    inputEl.addEventListener('keydown', e => {
        if (e.key === 'Enter' && inputArea.style.display !== 'none') {
            evaluateAnswer(inputEl.value.trim());
            e.preventDefault();
        }
    });

    // 次へボタン
    nextBtn.onclick = () => {
        currentIdx++;
        if (currentIdx < quizData.length && quizData[currentIdx]) {
            loadQuestion();
        } else {
            // 全5問終了後は自己採点画面へ
            showSelfCheck();
        }
    };

    // リザルト画面のボタンイベント
    document.getElementById('retry-btn').addEventListener('click', () => {
        location.reload();
    });
    document.getElementById('restart-btn').addEventListener('click', () => {
        // カテゴリ選択に戻す
        document.getElementById('score-area').style.display = 'none';
        categoryArea.style.display = 'block';
    });
    // 自己採点用ボタン
    document.getElementById('calc-score-btn').addEventListener('click', () => {
        const count = parseInt(document.getElementById('self-count').value, 10) || 0;
        score = count * 20;
        document.getElementById('selfcheck-area').style.display = 'none';
        showScore();
    });

    function showSelfCheck() {
        quizArea.style.display = 'none';
        const listEl = document.getElementById('answer-list');
        listEl.innerHTML = '';
        quizData.forEach((item, idx) => {
            const text = (item.choices && item.choices.length > 0)
                ? item.q
                : item.q.replace('（　）', `（${item.k || ''}）`);
            const p = document.createElement('p');
            p.style.margin = '4px 0';
            p.textContent = `${idx + 1}. ${text} → ${item.a}`;
            listEl.appendChild(p);
        });
        document.getElementById('selfcheck-area').style.display = 'block';
    }

    function showScore() {
        quizArea.style.display = 'none';
        document.getElementById('score-area').style.display = 'block';
        document.getElementById('final-score').innerText = score + '点';
    }
</script>
</body>
</html>