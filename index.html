<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼¢å­—ã‚¯ã‚¨ã‚¹ãƒˆ ã€œæ–°4å¹´ç”Ÿæ¼¢å­—ç·¨ã€œ</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; border-radius: 15px; width: 100%; max-width: 500px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h1 { color: #1a73e8; text-align: center; font-size: 1.5rem; margin-bottom: 5px; }
        .sub-title { text-align: center; color: #5f6368; font-size: 1rem; margin-bottom: 20px; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; }
        .stage-btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; background: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; font-size: 1.1rem; transition: 0.2s; display: flex; align-items: center; justify-content: space-between; }
        .stage-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .stage-d1 { border-left: 8px solid #4285f4; } .stage-d2 { border-left: 8px solid #34a853; }
        .stage-d3 { border-left: 8px solid #fbbc05; } .stage-d4 { border-left: 8px solid #ea4335; } .stage-d5 { border-left: 8px solid #9c27b0; }
        .level-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .level-btn { padding: 15px 0; border: none; border-radius: 8px; background: #e8f0fe; color: #1a73e8; font-weight: bold; cursor: pointer; }
        .level-btn.locked { background: #f1f3f4; color: #9aa0a6; cursor: not-allowed; }
        .level-btn.cleared { background: #34a853; color: white; }
        .question-box { font-size: 1.8rem; text-align: center; margin: 30px 0; font-weight: bold; color: #333; line-height: 1.6; }
        .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .choice-btn { padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; background: white; font-size: 1.1rem; cursor: pointer; }
        .choice-btn:hover { background: #f8f9fa; border-color: #1a73e8; }
        .note-area { background: #fff9c4; padding: 20px; border-radius: 10px; text-align: center; border: 2px dashed #fbc02d; margin-bottom: 20px; }
        .btn-primary { background: #1a73e8; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; width: 100%; margin-top: 10px; }
        #score-area { text-align: center; }
        .final-score { font-size: 3rem; font-weight: bold; color: #1a73e8; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="card">
        <h1>æ¼¢å­—ã‚¯ã‚¨ã‚¹ãƒˆ</h1>
        <div class="sub-title">ã€œæ–°4å¹´ç”Ÿæ¼¢å­—ç·¨ã€œ</div>

        <div id="stage-area">
            <button class="stage-btn stage-d1" onclick="showLevels('d1', 'èª­ã¿ã®è©¦ç·´')"><span>ğŸ”¥ d1: èª­ã¿ã®è©¦ç·´</span><span id="prog-d1">0%</span></button>
            <button class="stage-btn stage-d2" onclick="showLevels('d2', 'æ›¸ãã®é–¢æ‰€')"><span>âœï¸ d2: æ›¸ãã®é–¢æ‰€</span><span id="prog-d2">0%</span></button>
            <button class="stage-btn stage-d3" onclick="showLevels('d3', 'ä½¿ã„åˆ†ã‘ã®è¿·å®®')"><span>ğŸ” d3: ä½¿ã„åˆ†ã‘</span><span id="prog-d3">0%</span></button>
            <button class="stage-btn stage-d4" onclick="showLevels('d4', 'ç†Ÿèªã®è©¦ç·´')"><span>ğŸ“š d4: ç†Ÿèªã®è©¦ç·´</span><span id="prog-d4">0%</span></button>
            <button class="stage-btn stage-d5" onclick="showLevels('d5', 'ç©¶æ¥µã®ä½¿ã„åˆ†ã‘')"><span>ğŸ‘‘ d5: ç©¶æ¥µã®ä½¿ã„åˆ†ã‘</span><span id="prog-d5">0%</span></button>
        </div>

        <div id="level-area" style="display:none;">
            <button onclick="backToStages()" style="background:none; border:none; color:#1a73e8; cursor:pointer;">â† æˆ»ã‚‹</button>
            <h2 id="current-stage-name" style="text-align:center;"></h2>
            <div class="level-grid" id="level-buttons"></div>
        </div>

        <div id="quiz-area" style="display:none;">
            <div id="progress-text" style="text-align:right; color:#666;">1/5</div>
            <div id="question-text" class="question-box"></div>
            
            <div id="choice-container" class="choices-grid"></div>

            <div id="note-container" style="display:none;">
                <div class="note-area">
                    <div style="color:#f57f17; font-size:0.9rem; margin-bottom:5px;">ãƒãƒ¼ãƒˆã«æ›¸ã„ã¦ã­ï¼</div>
                    <div id="hint-text" style="font-size:1.5rem; letter-spacing:3px;"></div>
                </div>
                <button class="btn-primary" onclick="showAnswer()">æ›¸ã‘ãŸï¼ç­”ãˆåˆã‚ã›</button>
            </div>
        </div>

        <div id="selfcheck-area" style="display:none;">
            <div class="question-box" id="correct-answer" style="color:#d32f2f;"></div>
            <p style="text-align:center;">æ­£è§£ã¨åŒã˜æ¼¢å­—ãŒæ›¸ã‘ã¾ã—ãŸã‹ï¼Ÿ</p>
            <div class="choices-grid">
                <button class="choice-btn" onclick="nextQuestion(true)" style="border-color:#34a853;">âœ… æ›¸ã‘ãŸï¼</button>
                <button class="choice-btn" onclick="nextQuestion(false)" style="border-color:#ea4335;">âŒ ç·´ç¿’ã™ã‚‹</button>
            </div>
        </div>

        <div id="score-area" style="display:none;">
            <h2 id="clear-msg">ğŸŒŸ ã‚¯ãƒªã‚¢ï¼</h2>
            <div class="final-score" id="final-score">0 ç‚¹</div>
            <button class="btn-primary" id="retry-btn">ã‚‚ã†ä¸€åº¦</button>
            <button class="btn-primary" id="next-lv-btn" style="background:#34a853;">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸</button>
            <button class="btn-primary" onclick="backToLevels()" style="background:#9aa0a6;">ãƒ¬ãƒ™ãƒ«é¸æŠã¸æˆ»ã‚‹</button>
        </div>
    </div>

<script>
    const CURRENT_COURSE = "shin4_kanji";
    const JSON_BASE_PATH = "assets/json/shin4_kanji";
    const TOTAL_QUESTIONS = 5;

    let currentCategory = '';
    let currentLevel = 1;
    let quizData = [];
    let currentIdx = 0;
    let score = 0;

    window.onload = updateTopProgress;

    function updateTopProgress() {
        ['d1','d2','d3','d4','d5'].forEach(cat => {
            const unlocked = parseInt(localStorage.getItem(`${CURRENT_COURSE}_${cat}_progress`)) || 1;
            document.getElementById(`prog-${cat}`).innerText = Math.floor((unlocked - 1) * 20) + "%";
        });
    }

    function backToStages() {
        document.getElementById('level-area').style.display = 'none';
        document.getElementById('stage-area').style.display = 'block';
        updateTopProgress();
    }

    function showLevels(cat, name) {
        currentCategory = cat;
        document.getElementById('current-stage-name').innerText = name;
        document.getElementById('stage-area').style.display = 'none';
        document.getElementById('level-area').style.display = 'block';
        renderLevels();
    }

    function renderLevels() {
        const container = document.getElementById('level-buttons');
        container.innerHTML = '';
        const unlocked = parseInt(localStorage.getItem(`${CURRENT_COURSE}_${currentCategory}_progress`)) || 1;
        
        for (let i = 1; i <= 5; i++) {
            const btn = document.createElement('button');
            btn.className = `level-btn ${i > unlocked ? 'locked' : (i < unlocked ? 'cleared' : '')}`;
            btn.innerText = i;
            if (i <= unlocked) btn.onclick = () => loadStage(currentCategory, i);
            container.appendChild(btn);
        }
    }

    async function loadStage(cat, level) {
        currentLevel = level;
        const filePath = `${JSON_BASE_PATH}/stage_${cat}.json`;
        
        try {
            const response = await fetch(filePath);
            if (!response.ok) throw new Error("File not found");
            const data = await response.json();
            const levelData = data.levels.find(l => l.level == level);
            
            // 5å•ã‚’ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡º
            quizData = levelData.questions.sort(() => 0.5 - Math.random()).slice(0, TOTAL_QUESTIONS);
            
            currentIdx = 0; score = 0;
            document.getElementById('level-area').style.display = 'none';
            document.getElementById('score-area').style.display = 'none';
            document.getElementById('quiz-area').style.display = 'block';
            loadQuestion();
        } catch (e) { 
            alert("ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã‚’ç¢ºèªã—ã¦ãã ã•ã„: " + filePath); 
        }
    }

    function loadQuestion() {
        const q = quizData[currentIdx];
        document.getElementById('progress-text').innerText = `${currentIdx + 1}/${TOTAL_QUESTIONS}`;
        document.getElementById('question-text').innerText = q.q;

        if (currentCategory === 'd1' || currentCategory === 'd3' || currentCategory === 'd4' || currentCategory === 'd5') {
            // é¸æŠè‚¢å½¢å¼
            document.getElementById('choice-container').style.display = 'grid';
            document.getElementById('note-container').style.display = 'none';
            const container = document.getElementById('choice-container');
            container.innerHTML = '';
            q.choices.forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = c;
                btn.onclick = () => checkAnswer(c === q.a);
                container.appendChild(btn);
            });
        } else {
            // æ›¸ãå–ã‚Šå½¢å¼
            document.getElementById('choice-container').style.display = 'none';
            document.getElementById('note-container').style.display = 'block';
            document.getElementById('hint-text').innerText = q.k;
        }
    }

    function checkAnswer(isCorrect) {
        if (isCorrect) score++;
        nextQuestion();
    }

    function showAnswer() {
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('selfcheck-area').style.display = 'block';
        document.getElementById('correct-answer').innerText = quizData[currentIdx].a;
    }

    function nextQuestion(selfIsCorrect = false) {
        if (currentCategory === 'd2' && selfIsCorrect) score++;
        
        currentIdx++;
        document.getElementById('selfcheck-area').style.display = 'none';
        if (currentIdx < TOTAL_QUESTIONS) {
            document.getElementById('quiz-area').style.display = 'block';
            loadQuestion();
        } else {
            showScore();
        }
    }

    function showScore() {
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('score-area').style.display = 'block';
        const finalScore = (score / TOTAL_QUESTIONS) * 100;
        document.getElementById('final-score').innerText = `${finalScore} ç‚¹`;
        
        const clearMsg = document.getElementById('clear-msg');
        const nextLvBtn = document.getElementById('next-lv-btn');
        
        if (finalScore >= 80) {
            clearMsg.innerText = "ğŸŒŸ åˆæ ¼ï¼æ¬¡ã®ãƒ¬ãƒ™ãƒ«ãŒé–‹æ”¾ã•ã‚ŒãŸã‚ˆï¼";
            const storageKey = `${CURRENT_COURSE}_${currentCategory}_progress`;
            const currentUnlocked = parseInt(localStorage.getItem(storageKey)) || 1;
            if (currentLevel >= currentUnlocked) {
                localStorage.setItem(storageKey, currentLevel + 1);
            }
            nextLvBtn.style.display = currentLevel < 5 ? 'block' : 'none';
        } else {
            clearMsg.innerText = "ã‚ã¨å°‘ã—ï¼ã‚‚ã†ä¸€åº¦ã‚„ã£ã¦ã¿ã‚ˆã†ã€‚";
            nextLvBtn.style.display = 'none';
        }
        
        document.getElementById('retry-btn').onclick = () => loadStage(currentCategory, currentLevel);
        nextLvBtn.onclick = () => loadStage(currentCategory, currentLevel + 1);
    }

    function backToLevels() {
        document.getElementById('score-area').style.display = 'none';
        document.getElementById('level-area').style.display = 'block';
        renderLevels();
    }
</script>
</body>
</html>