<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼¢å­—ã‚¯ã‚¨ã‚¹ãƒˆ ã€œæ–°4å¹´ç”Ÿæ¼¢å­—ç·¨ã€œ</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; border-radius: 15px; width: 100%; max-width: 500px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h1 { color: #1a73e8; text-align: center; font-size: 1.5rem; margin-bottom: 5px; }
        .sub-title { text-align: center; color: #5f6368; font-size: 1rem; margin-bottom: 20px; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; }
        .question-box { font-size: 1.8rem; text-align: center; margin: 30px 0; font-weight: bold; color: #333; line-height: 1.6; }
        .guide-msg { text-align: center; color: #666; margin-bottom: 10px; font-weight: bold; }
        button { width: 100%; padding: 12px; font-size: 1.1rem; border: none; border-radius: 8px; cursor: pointer; transition: background 0.2s; margin-top: 10px; }
        .btn-primary { background-color: #1a73e8; color: white; }
        .btn-primary:hover { background-color: #1557b0; }
        
        .btn-d1 { border-left: 8px solid #3498db; }
        .btn-d2 { border-left: 8px solid #e67e22; }
        .btn-d3 { border-left: 8px solid #27ae60; }
        .btn-d4 { border-left: 8px solid #9b59b6; }
        .btn-d5 { border-left: 8px solid #e74c3c; }
        
        .btn-locked { background-color: #ccc; color: #666; cursor: not-allowed; position: relative; }
        .btn-locked::after { content: "ğŸ”’"; position: absolute; right: 15px; }
        .choice-btn { background-color: #ffffff; border: 2px solid #1a73e8; color: #1a73e8; margin-bottom: 10px; text-align: left; padding-left: 20px; }
        .choice-btn:hover:not(:disabled) { background-color: #e8f0fe; }
        .choice-btn:disabled { opacity: 0.8; color: #333; }
        .feedback { padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; font-weight: bold; }
        .correct { background-color: #e6f4ea; color: #1e8e3e; }
        .wrong { background-color: #fce8e6; color: #d93025; }
        #selfcheck-area, #score-area, #level-area, #quiz-area { display: none; }
        .answer-item { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 1rem; }
        input[type="number"] { width: 60px; padding: 8px; font-size: 1.2rem; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
        .mode-section { margin-top: 30px; padding-top: 20px; border-top: 2px dashed #eee; text-align: center; }
        .reset-link { margin-top: 50px; text-align: center; }
        .reset-link a { color: #ccc; font-size: 0.8rem; text-decoration: none; }
    </style>
</head>
<body>

<div class="card">
    <h1>æ¼¢å­—ã‚¯ã‚¨ã‚¹ãƒˆ</h1>
    <div class="sub-title">ã€œæ–°4å¹´ç”Ÿæ¼¢å­—ç·¨ã€œ</div>

    <div id="category-area">
        <p style="text-align:center;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã­</p>
        <button class="btn-primary btn-d1" onclick="selectCategory('d1')">â‘  èª­ã¿ã®è©¦ç·´ï¼ˆ4æŠï¼‰</button>
        <button class="btn-primary btn-d2" onclick="selectCategory('d2')">â‘¡ æ›¸ãã®é–¢æ‰€ï¼ˆãƒãƒ¼ãƒˆï¼‰</button>
        <button class="btn-primary btn-d3" onclick="selectCategory('d3')">â‘¢ ä½¿ã„åˆ†ã‘ã®è¿·å®®ï¼ˆ4æŠï¼‰</button>
        <button class="btn-primary btn-d4" onclick="selectCategory('d4')">â‘£ ç†Ÿèªã®è©¦ç·´ï¼ˆ4æŠï¼‰</button>
        <button class="btn-primary btn-d5" onclick="selectCategory('d5')">â‘¤ ç©¶æ¥µã®ä½¿ã„åˆ†ã‘ï¼ˆ4æŠï¼‰</button>

        <div class="mode-section">
            <p style="color:#888; font-size:0.9rem;">ã€ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ï¼šã˜ã£ãã‚Šå­¦ç¿’ã€‘</p>
            <button disabled style="background:#eee; color:#aaa; cursor:default;">â± ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼ˆé–‹ç™ºä¸­ï¼‰</button>
        </div>

        <div class="reset-link">
            <a href="#" onclick="resetData()">é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ</a>
        </div>
    </div>

    <div id="level-area">
        <button style="background:#eee;" onclick="location.reload()">â† ã‚‚ã©ã‚‹</button>
        <p id="level-title" style="text-align:center; font-weight:bold; margin-top:15px;"></p>
        <div id="level-buttons"></div>
    </div>

    <div id="quiz-area">
        <div id="progress" style="text-align:right; color:#888;"></div>
        <div id="guide" class="guide-msg"></div>
        <div id="question" class="question-box"></div>
        <div id="choices-area"></div>
        <div id="feedback" class="feedback"><div id="result-text"></div></div>
        <button id="next-btn" class="btn-primary" style="display:none;">æ¬¡ã¸é€²ã‚€</button>
    </div>

    <div id="selfcheck-area">
        <h2>ç­”ãˆåˆã‚ã›</h2>
        <div id="answer-list" style="margin-bottom:20px; text-align:left;"></div>
        <div style="text-align:center; border-top: 2px solid #eee; padding-top:20px;">
            <p>ä½•å•æ­£è§£ã ã£ãŸï¼Ÿ</p>
            <input type="number" id="self-count" min="0" max="5" value="0"> å• / 5å•
            <button class="btn-primary" onclick="submitSelfScore()">ç‚¹æ•°ã‚’ç¢ºèªã™ã‚‹</button>
        </div>
    </div>

    <div id="score-area">
        <h2 style="text-align:center;">çµæœç™ºè¡¨</h2>
        <div id="final-score" style="font-size:3rem; text-align:center; color:#1a73e8; margin:20px 0;"></div>
        <div id="clear-msg" style="text-align:center; margin-bottom:20px; font-weight:bold; color:#1e8e3e;"></div>
        <button class="btn-primary" id="retry-btn">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>
        <button class="btn-primary" id="next-lv-btn" style="background-color:#34a853;">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸é€²ã‚€</button>
        <button style="background:#e8f0fe; color:#1a73e8;" onclick="backToLevels()">ãƒ¬ãƒ™ãƒ«é¸æŠã«æˆ»ã‚‹</button>
        <button style="background:#eee;" onclick="location.reload()">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
    const CURRENT_COURSE = 'shin4_kanji'; 
    // â˜…â˜…â˜… ã“ã“ã‚’çµ¶å¯¾ã«é–“é•ãˆãªã„ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ãŸ â˜…â˜…â˜…
    const JSON_BASE_PATH = 'assets/json/shin4_kanji'; 
    
    let currentCategory = '';
    let currentLevel = 1;
    let quizData = [];
    let currentIdx = 0;
    let autoScore = 0;
    let isChoiceMode = false;
    const TOTAL_QUESTIONS = 5;

    window.onload = updateTopProgress;

    function resetData() {
        if(confirm('è¨˜éŒ²ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.clear(); location.reload(); }
    }

    function updateTopProgress() {
        ['d1', 'd2', 'd3', 'd4', 'd5'].forEach(cat => {
            const progress = parseInt(localStorage.getItem(`${CURRENT_COURSE}_${cat}_progress`)) || 1;
            const btn = document.querySelector(`.btn-${cat}`);
            if (btn) {
                const baseText = btn.innerText.split(' [')[0];
                const displayLv = progress > 5 ? 5 : progress;
                btn.innerText = `${baseText} [Lv.${displayLv}]`;
            }
        });
    }

    function selectCategory(cat) {
        currentCategory = cat;
        document.getElementById('category-area').style.display = 'none';
        document.getElementById('level-area').style.display = 'block';
        const titles = { 'd1': 'ã€èª­ã¿ã€‘', 'd2': 'ã€æ›¸ãã€‘', 'd3': 'ã€ä½¿ã„åˆ†ã‘ã€‘', 'd4': 'ã€ç†Ÿèªã€‘', 'd5': 'ã€ç©¶æ¥µã€‘' };
        document.getElementById('level-title').innerText = titles[cat] + "ãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ã­";
        renderLevels();
    }

    function renderLevels() {
        const btnContainer = document.getElementById('level-buttons');
        btnContainer.innerHTML = '';
        const unlockedLevel = parseInt(localStorage.getItem(`${CURRENT_COURSE}_${currentCategory}_progress`)) || 1;
        for(let lv=1; lv<=5; lv++) {
            const btn = document.createElement('button');
            if (lv <= unlockedLevel) {
                btn.className = 'btn-primary';
                btn.innerText = `ãƒ¬ãƒ™ãƒ« ${lv}`;
                btn.onclick = () => loadStage(currentCategory, lv);
            } else {
                btn.className = 'btn-locked';
                btn.innerText = `ãƒ¬ãƒ™ãƒ« ${lv}`;
                btn.onclick = () => alert("å‰ã®ãƒ¬ãƒ™ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã­ï¼");
            }
            btnContainer.appendChild(btn);
        }
    }

    async function loadStage(cat, level) {
        currentLevel = level;
        // ã“ã‚Œã§ assets/json/shin4_kanji/stage_d1.json ã«ãªã‚Šã¾ã™
        const filePath = `${JSON_BASE_PATH}/stage_${cat}.json`;
        
        try {
            const response = await fetch(filePath);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            const levelData = data.levels.find(l => l.level == level);
            if (!levelData) {
                alert(`ã‚¨ãƒ©ãƒ¼ï¼šãƒ¬ãƒ™ãƒ« ${level} ã®ãƒ‡ãƒ¼ã‚¿ãŒJSONå†…ã«ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                return;
            }
            quizData = levelData.questions.sort(() => 0.5 - Math.random()).slice(0, TOTAL_QUESTIONS);
            
            currentIdx = 0; autoScore = 0;
            document.getElementById('level-area').style.display = 'none';
            document.getElementById('score-area').style.display = 'none';
            document.getElementById('quiz-area').style.display = 'block';
            loadQuestion();
        } catch (e) { 
            console.error(e);
            alert(`èª­ã¿è¾¼ã¿å¤±æ•—ï¼š${filePath}\nãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆï¼ˆassets/json/shin4_kanji/ï¼‰ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        }
    }

    function loadQuestion() {
        const current = quizData[currentIdx];
        document.getElementById('progress').innerText = `${currentIdx + 1} / ${TOTAL_QUESTIONS}`;
        document.getElementById('feedback').style.display = 'none';
        const choicesArea = document.getElementById('choices-area');
        const nextBtn = document.getElementById('next-btn');
        const questionEl = document.getElementById('question');
        choicesArea.innerHTML = '';

        if (currentCategory !== 'd2') {
            isChoiceMode = true;
            document.getElementById('guide').innerText = "æ­£ã—ã„ã‚‚ã®ã‚’é¸ã‚“ã§ã­ï¼";
            questionEl.innerText = current.q;
            nextBtn.style.display = 'none';
            [...current.choices].sort(() => 0.5 - Math.random()).forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = choice;
                btn.onclick = () => {
                    Array.from(document.getElementsByClassName('choice-btn')).forEach(b => b.disabled = true);
                    const feedback = document.getElementById('feedback');
                    if (choice === current.a) {
                        document.getElementById('result-text').innerText = "â­• æ­£è§£ï¼";
                        feedback.className = "feedback correct";
                        autoScore += 20;
                    } else {
                        document.getElementById('result-text').innerText = `âŒ æ®‹å¿µï¼ æ­£è§£ã¯ã€Œ${current.a}ã€`;
                        feedback.className = "feedback wrong";
                    }
                    feedback.style.display = 'block';
                    nextBtn.style.display = 'block';
                };
                choicesArea.appendChild(btn);
            });
        } else {
            isChoiceMode = false;
            document.getElementById('guide').innerText = "ãƒãƒ¼ãƒˆã«æ¼¢å­—ã‚’æ›¸ã„ã¦ã­ï¼";
            // jsonã® k ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒ’ãƒ³ãƒˆã¨ã—ã¦è¡¨ç¤º
            questionEl.innerText = current.q.replace('ï¼ˆã€€ï¼‰', `ï¼ˆ ${current.k || ''} ï¼‰`);
            nextBtn.style.display = 'block';
        }
    }

    document.getElementById('next-btn').onclick = () => {
        currentIdx++;
        if (currentIdx < quizData.length) loadQuestion();
        else {
            document.getElementById('quiz-area').style.display = 'none';
            isChoiceMode ? showScore(autoScore) : showSelfCheck();
        }
    };

    function showSelfCheck() {
        const listEl = document.getElementById('answer-list');
        listEl.innerHTML = '';
        quizData.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'answer-item';
            div.innerHTML = `<strong>${idx+1}.</strong> ${item.q.replace('ï¼ˆã€€ï¼‰', `ï¼ˆ${item.k}ï¼‰`)} â†’ <span style="color:#d93025; font-weight:bold;">${item.a}</span>`;
            listEl.appendChild(div);
        });
        document.getElementById('selfcheck-area').style.display = 'block';
    }

    function submitSelfScore() { showScore(document.getElementById('self-count').value * 20); }

    function showScore(finalScore) {
        document.getElementById('selfcheck-area').style.display = 'none';
        document.getElementById('score-area').style.display = 'block';
        document.getElementById('final-score').innerText = `${finalScore} ç‚¹`;
        const clearMsg = document.getElementById('clear-msg');
        const nextLvBtn = document.getElementById('next-lv-btn');
        if (finalScore >= 80) {
            clearMsg.innerText = "ğŸŒŸ åˆæ ¼ï¼æ¬¡ã®ãƒ¬ãƒ™ãƒ«ãŒé–‹æ”¾ã•ã‚ŒãŸã‚ˆï¼";
            const storageKey = `${CURRENT_COURSE}_${currentCategory}_progress`;
            const currentUnlocked = parseInt(localStorage.getItem(storageKey)) || 1;
            if (currentLevel >= currentUnlocked) {
                localStorage.setItem(storageKey, currentLevel + 1);
                updateTopProgress();
            }
            nextLvBtn.style.display = currentLevel < 5 ? 'block' : 'none';
        } else {
            clearMsg.innerText = "ã‚ã¨å°‘ã—ï¼ã‚‚ã†ä¸€åº¦ã‚„ã£ã¦ã¿ã‚ˆã†ã€‚";
            nextLvBtn.style.display = 'none';
        }
        document.getElementById('retry-btn').onclick = () => loadStage(currentCategory, currentLevel);
        nextLvBtn.onclick = () => loadStage(currentCategory, currentLevel + 1);
    }

    function backToLevels() {
        document.getElementById('score-area').style.display = 'none';
        document.getElementById('level-area').style.display = 'block';
        renderLevels();
    }
</script>
</body>
</html>